# ç«äº‰GPUç®¡ç†é€»è¾‘

## æ¦‚è¿°

ä¸ºäº†æœ‰æ•ˆç®¡ç†å¤šä¸ªè„šæœ¬å¯¹GPUèµ„æºçš„ç«äº‰ä½¿ç”¨ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªåŸºäºå”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆuni_idï¼‰çš„è¿›ç¨‹ç®¡ç†ç³»ç»Ÿã€‚è¯¥ç³»ç»Ÿå…è®¸å¤–éƒ¨ç›‘æ§è„šæœ¬ï¼ˆå¦‚ `compete_gpus_retry.py`ï¼‰è·Ÿè¸ªæ­£åœ¨è¿è¡Œçš„Pythonè¿›ç¨‹ï¼Œå¹¶åœ¨é€‚å½“çš„æ—¶æœºå¯åŠ¨æ–°çš„ä»»åŠ¡ã€‚

## ä»£ç ç»“æ„ï¼ˆæ¨¡å—åŒ–ç‰ˆæœ¬ï¼‰

```
scripts/compete_gpu_retry/
â”œâ”€â”€ compete_gpus_retry.py      # ä¸»è°ƒåº¦å™¨
â”œâ”€â”€ command.txt                # ä»»åŠ¡é…ç½®æ–‡ä»¶
â””â”€â”€ utils/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ gpu_monitor.py         # GPU çŠ¶æ€ç›‘æ§
    â”œâ”€â”€ process_json.py        # JSON æ–‡ä»¶ç®¡ç†
    â””â”€â”€ retry.py               # é‡è¯•æœºåˆ¶
```

### æ¨¡å—è¯´æ˜

| æ¨¡å— | åŠŸèƒ½ |
|------|------|
| `gpu_monitor.py` | GPU æ˜¾å­˜æ£€æµ‹ã€ç”¨æˆ·è¿›ç¨‹æ£€æµ‹ã€GPU åˆ—è¡¨æ¢æµ‹ |
| `process_json.py` | uni_id.json æ–‡ä»¶çš„è¯»å†™ã€è¿›ç¨‹çŠ¶æ€ç®¡ç† |
| `retry.py` | é‡è¯•é…ç½®ã€é€€é¿ç­–ç•¥ã€ä»»åŠ¡çŠ¶æ€æ£€æŸ¥ |
| `parse_command_file.py` | å‘½ä»¤é…ç½®æ–‡ä»¶è§£æå™¨ |
| `command.txt` | ä»»åŠ¡é…ç½®æ–‡ä»¶ï¼Œä¾¿äºç®¡ç†å’Œä¿®æ”¹ |

## ä»£ç æ ¸å¿ƒé€»è¾‘

æ ¸å¿ƒé€»è¾‘ï¼š**é˜Ÿåˆ—å†…ä¸²è¡Œï¼Œé˜Ÿåˆ—é—´å¹¶è¡Œï¼Œé¡ºåºåˆ†é…**æ‰§è¡Œè¿›ç¨‹ã€‚

- **é˜Ÿåˆ—å†…ä¸²è¡Œ**ï¼šåŒä¸€é˜Ÿåˆ—çš„ä»»åŠ¡ä¸¥æ ¼æŒ‰é¡ºåºæ‰§è¡Œï¼Œå‰ä¸€ä¸ªä»»åŠ¡å®Œæˆåæ‰èƒ½å¯åŠ¨ä¸‹ä¸€ä¸ª
- **é˜Ÿåˆ—é—´å¹¶è¡Œ**ï¼šä¸åŒé˜Ÿåˆ—çš„ä»»åŠ¡å¯ä»¥åŒæ—¶åœ¨ä¸åŒ GPU ä¸Šæ‰§è¡Œ
- **é¡ºåºåˆ†é…**ï¼šæ¯æ¬¡åªåˆ†é…ä¸€ä¸ªä»»åŠ¡ï¼Œç­‰å¾…è¿›ç¨‹ç¡®è®¤å¯åŠ¨åï¼ˆ30ç§’å»¶è¿Ÿï¼‰å†åˆ†é…ä¸‹ä¸€ä¸ªï¼Œé¿å… GPU è¿›ç¨‹æœªåŠæ—¶æ˜¾ç¤ºå¯¼è‡´é‡å¤åˆ†é…
- **é‡è¯•æœºåˆ¶**ï¼šè¿›ç¨‹å‘ç”Ÿå¼‚å¸¸åè¦è¿›è¡Œé‡è¯•ï¼Œé‡è¯•è¶…ä¸Šé™ï¼ˆ3æ¬¡ï¼‰åé€€é¿ä¸€æ®µæ—¶é—´ï¼ˆ10åˆ†é’Ÿï¼‰å†è¿›è¡Œä¸‹ä¸€æ¬¡é‡è¯•

æ•´ä½“æµç¨‹ï¼š**ä»»åŠ¡é…ç½® â†’ é˜Ÿåˆ—åˆ†ç»„ â†’ ç©ºé—²é˜Ÿåˆ—å¤´ä»»åŠ¡éšæœºè°ƒåº¦ â†’ é€ä¸ªåˆ†é… GPU â†’ ç­‰å¾…è¿›ç¨‹ç¡®è®¤ â†’ çŠ¶æ€ç›‘æ§**ã€‚

### 1. ä»»åŠ¡ä¸é˜Ÿåˆ—

1. æ‰€æœ‰å¾…æ‰§è¡Œä»»åŠ¡ä» `command.txt` æ–‡ä»¶ä¸­è¯»å–ã€‚
2. å¯åŠ¨æ—¶è„šæœ¬ä¸ºæ¯ä¸ªä»»åŠ¡ç”Ÿæˆå”¯ä¸€çš„ `uni_id`ï¼Œå¹¶æ„é€ æˆ `Task` å¯¹è±¡ï¼Œ**æš‚ä¸ç»‘å®šå…·ä½“ GPU**ã€‚

#### command.txt æ ¼å¼è¯´æ˜

```
# æ³¨é‡Šè¡Œï¼ˆä»¥ # å¼€å¤´ï¼‰
# ç©ºè¡Œåˆ†éš”ä¸åŒä»»åŠ¡

# ä»»åŠ¡1ï¼šé˜Ÿåˆ—1
å‘½ä»¤1
å‘½ä»¤2
å‘½ä»¤3
é˜Ÿåˆ—ID,æ˜¾å­˜éœ€æ±‚(GB)

# ä»»åŠ¡2ï¼šé˜Ÿåˆ—2
å‘½ä»¤1
å‘½ä»¤2
é˜Ÿåˆ—ID,æ˜¾å­˜éœ€æ±‚(GB)
```

**æ”¯æŒçš„å˜é‡**ï¼š
- `{work_dir}` - å·¥ä½œç›®å½•
- `{uni_id}` - å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰

**ç¤ºä¾‹**ï¼š
```
# æ±½è½¦æ•°æ®é›†ä»»åŠ¡
rm -rf {work_dir}/experiments/car196/knowledge_base
bash {work_dir}/scripts/set_hyperparameters.sh --experience_number 8
bash {work_dir}/scripts/run_pipeline.sh car --uni_id {uni_id}
1,20
```

#### parse_command_file.py æ¨¡å—

è´Ÿè´£è§£æ `command.txt` æ–‡ä»¶ï¼Œå°†æ–‡æœ¬æ ¼å¼çš„ä»»åŠ¡é…ç½®è½¬æ¢ä¸º Python æ•°æ®ç»“æ„ã€‚

**ä¸»è¦åŠŸèƒ½**ï¼š
- è§£ææ³¨é‡Šå’Œç©ºè¡Œ
- æå–å‘½ä»¤åˆ—è¡¨
- è§£æé˜Ÿåˆ— ID å’Œæ˜¾å­˜éœ€æ±‚
- é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

**ä½¿ç”¨æ–¹å¼**ï¼š
```python
from utils import parse_command_file

tasks = parse_command_file('command.txt')
# è¿”å›: List[(commands, queue_id, memory_gb)]
```
3. æ ¹æ®é˜Ÿåˆ— ID å°†ä»»åŠ¡åˆ†ç»„ï¼š
   - **åŒä¸€é˜Ÿåˆ—å†…**ï¼šä¸¥æ ¼æŒ‰é¡ºåºæ‰§è¡Œï¼ˆé˜Ÿåˆ—å†…ä¸²è¡Œï¼‰
   - **ä¸åŒé˜Ÿåˆ—ä¹‹é—´**ï¼šå¯åŒæ—¶è°ƒåº¦ï¼ˆé˜Ÿåˆ—é—´å¹¶è¡Œï¼‰

### 2. GPU åˆ†é…ä¸è¿›ç¨‹ç®¡ç†

4. **GPU ç«äº‰èŒƒå›´é…ç½®**ï¼š
   - `use_all_gpus=True`ï¼šè‡ªåŠ¨æ¢æµ‹æ‰€æœ‰å¯ç”¨ GPU
   - `use_all_gpus=False`ï¼šä½¿ç”¨ `compete_gpus` æŒ‡å®šçš„ GPU åˆ—è¡¨

5. **è°ƒåº¦æ ¸å¿ƒç®—æ³•**ï¼ˆ`run` æ–¹æ³•ï¼‰ï¼š
   ```
   while æœ‰å¾…æ‰§è¡Œä»»åŠ¡:
       1. è·å–å½“å‰å¿™ç¢Œé˜Ÿåˆ—ï¼ˆé€šè¿‡ JSON ä¸­ state=running çš„è¿›ç¨‹ï¼‰
       2. è·å–æ‰€æœ‰ç©ºé—²é˜Ÿåˆ—çš„å¤´éƒ¨ä»»åŠ¡
       3. éšæœºæ‰“ä¹±ä»»åŠ¡é¡ºåºï¼ˆå…¬å¹³è°ƒåº¦ï¼‰
       4. é€ä¸ªåˆ†é…ä»»åŠ¡ï¼š
          a. æŸ¥æ‰¾å¯ç”¨ GPUï¼ˆæ˜¾å­˜è¶³å¤Ÿ + éæé™æ¨¡å¼ä¸‹æ— ç”¨æˆ·è¿›ç¨‹ï¼‰
          b. æ‰§è¡Œä»»åŠ¡å‘½ä»¤
          c. ç­‰å¾…è¿›ç¨‹ç¡®è®¤å¯åŠ¨ï¼ˆæ£€æŸ¥ JSON ä¸­çš„ PIDï¼‰
          d. ç­‰å¾… 30 ç§’å†åˆ†é…ä¸‹ä¸€ä¸ªä»»åŠ¡
       5. æ‰“å°çŠ¶æ€ï¼Œç­‰å¾…ä¸‹ä¸€è½®è°ƒåº¦
   ```

6. **å…³é”®çº¦æŸ**ï¼š
   - éæé™æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ª GPU åŒæ—¶åªå…è®¸ä¸€ä¸ªå½“å‰ç”¨æˆ·çš„ Python è¿›ç¨‹
   - æ¯æ¬¡åˆ†é…åç­‰å¾… 30 ç§’ï¼Œç¡®ä¿ GPU è¿›ç¨‹å·²æ˜¾ç¤ºåœ¨ nvidia-smi ä¸­
   - é€šè¿‡ `uni_id.json` è¿½è¸ªè¿›ç¨‹çŠ¶æ€ï¼Œè€Œéä»…ä¾èµ–å†…å­˜ä¸­çš„ä»»åŠ¡çŠ¶æ€

### 2.5 è¿›ç¨‹çŠ¶æ€ä¸é‡è¯•æœºåˆ¶ï¼ˆcompete_gpus_retryï¼‰

7. åœ¨åŸæœ‰ `uni_id â†’ PID` æ˜ å°„çš„åŸºç¡€ä¸Šï¼ŒJSON ä¸­ä¸ºæ¯ä¸ªæ¡ç›®æ–°å¢å…³é”®å­—æ®µï¼š
   - `state`ï¼šè®°å½•è¿›ç¨‹è¿è¡ŒçŠ¶æ€ï¼Œå¯å–å€¼ï¼š
     - `running`ï¼šè¿›ç¨‹å·²å¯åŠ¨ä¸”ä»åœ¨è¿è¡Œä¸­ï¼›
     - `normal_exit`ï¼šè¿›ç¨‹æ­£å¸¸é€€å‡ºï¼ˆè¿”å›ç ä¸º 0ï¼‰ï¼›
     - `abnormal_exit`ï¼šè¿›ç¨‹å¼‚å¸¸é€€å‡ºï¼ˆè¿”å›ç é 0ï¼Œæˆ–è¢«ä¿¡å·ç»ˆæ­¢ï¼‰ï¼›
   - `retry_count`ï¼šè®°å½•å½“å‰ä»»åŠ¡çš„é‡è¯•æ¬¡æ•°ï¼ˆä» 0 å¼€å§‹è®¡æ•°ï¼‰ï¼›
   - `error_type`ï¼šå½“ `state=abnormal_exit` æ—¶è®°å½•å¼‚å¸¸ç±»å‹ï¼ˆä¾‹å¦‚ `oom` è¡¨ç¤ºæ˜¾å­˜æº¢å‡ºï¼Œ`runtime_error` ç­‰ï¼‰ã€‚

8. `compete_gpus_retry.py` ä½œä¸ºå¸¦é‡è¯•åŠŸèƒ½çš„ç«äº‰è„šæœ¬ï¼Œä¼šå‘¨æœŸæ€§æ‰«æ JSON å¹¶æ‰§è¡Œ**æ— é™é‡è¯• + é€€é¿æœºåˆ¶**ï¼š
   - å¯¹äº `state=abnormal_exit` çš„ä»»åŠ¡ï¼š
     - å°† `retry_count` åŠ  1ï¼›
     - å¦‚æœ `retry_count` æ˜¯ 3 çš„å€æ•°ï¼ˆå³ 3ã€6ã€9â€¦ï¼‰ï¼Œåˆ™è¿›å…¥**é€€é¿ç­‰å¾… 10 åˆ†é’Ÿ**ï¼ŒæœŸé—´è¯¥ä»»åŠ¡ä¸ä¼šè¢«é‡æ–°æäº¤åˆ°é˜Ÿåˆ—ï¼›
     - é€€é¿ç»“æŸåï¼Œé‡æ–°å°†åŒä¸€ä»»åŠ¡æäº¤åˆ°é˜Ÿåˆ—ï¼Œè§¦å‘é‡è¯•ï¼›
   - å¯¹äº `state=normal_exit` çš„ä»»åŠ¡ï¼Œè®¤ä¸ºç”Ÿå‘½å‘¨æœŸå·²å®Œæˆï¼Œå¯ä»¥å®‰å…¨åœ°ä» JSON ä¸­æ¸…ç†å¯¹åº”çš„ `uni_id` è®°å½•ï¼›
   - å¯¹äº `state=running` çš„ä»»åŠ¡ï¼Œä»…ç”¨äºç›‘æ§ï¼Œä¸è§¦å‘é‡è¯•ä¹Ÿä¸æ¸…ç†ã€‚

9. **é‡è¯•ä¸é˜Ÿåˆ—ä¸²è¡Œçš„å…³ç³»**ï¼š
   - é‡è¯•è¡Œä¸º**ä¸ä¼šç ´åé˜Ÿåˆ—å†…ä¸²è¡Œçº¦æŸ**ï¼šä¸€ä¸ªä»»åŠ¡ï¼ˆåŒ…æ‹¬å…¶æ‰€æœ‰é‡è¯•ï¼‰å¿…é¡»æˆåŠŸè¿è¡Œï¼ˆ`normal_exit`ï¼‰åï¼ŒåŒä¸€é˜Ÿåˆ—çš„åç»­ä»»åŠ¡æ‰èƒ½è¢«è°ƒåº¦ï¼›
   - åœ¨ä»»åŠ¡é‡è¯•æœŸé—´ï¼ˆåŒ…æ‹¬é€€é¿ç­‰å¾…ï¼‰ï¼Œè¯¥é˜Ÿåˆ—è¢«è§†ä¸º"å¿™ç¢Œ"ï¼Œåç»­ä»»åŠ¡ç»§ç»­ `pending`ï¼›
   - åªæœ‰å½“ä»»åŠ¡æœ€ç»ˆ `normal_exit` æ—¶ï¼Œé˜Ÿåˆ—çŠ¶æ€æ‰ä¼šä»"å¿™ç¢Œ"å˜ä¸º"ç©ºé—²"ã€‚

10. **uni_id æ¸…ç†ç­–ç•¥**ï¼š
    - `normal_exit`ï¼šæ¸…ç† JSON ä¸­å¯¹åº”çš„ `uni_id`ï¼Œé‡Šæ”¾ç®¡ç†è´Ÿæ‹…ï¼›
    - `abnormal_exit`ï¼šä¿ç•™è®°å½•ã€`error_type` å’Œ `retry_count`ï¼Œä¾¿äºæ— é™é‡è¯•ä¸æ’éšœã€‚

### 3. é˜Ÿåˆ—æ¨è¿›ä¸çŠ¶æ€ç›‘æ§

11. éšç€ä»»åŠ¡æ‰§è¡Œç»“æŸæˆ–å¤±è´¥ï¼Œ`CommandTask` çš„çŠ¶æ€ä» `running` æ›´æ–°ä¸º `completed/failed`ï¼Œå…¶æ‰€å±é˜Ÿåˆ—ä»"å¿™ç¢Œ"å˜ä¸ºç©ºé—²ï¼š
    - åŒä¸€é˜Ÿåˆ—çš„ä¸‹ä¸€ä¸ª `pending` ä»»åŠ¡ä¼šåœ¨ä¸‹ä¸€è½®è°ƒåº¦ä¸­è¢«é€‰ä¸­ç»§ç»­æ‰§è¡Œï¼›
    - å…¶ä»–é˜Ÿåˆ—å¦‚æœä¹Ÿç©ºé—²ä¸”æœ‰ GPU å¯ç”¨ï¼Œä¼šå¹¶è¡Œè¢«è°ƒåº¦ã€‚

12. æ—¥å¿—ç³»ç»Ÿä¼šå®šæœŸæ‰“å°ï¼š
    - ä»»åŠ¡æ€»ä½“ç»Ÿè®¡ï¼ˆPending/Running/Completed/Failedï¼‰ï¼›
    - å„é˜Ÿåˆ— Busy/Idle çŠ¶æ€ï¼ˆåŒ…æ‹¬ä» JSON æ£€æµ‹åˆ°çš„å®é™…è¿è¡Œè¿›ç¨‹ï¼‰ï¼›
    - æ¯å— GPU çš„å¯ç”¨æ˜¾å­˜ã€ç”¨æˆ·è¿›ç¨‹æ•°å’Œè¿è¡Œä»»åŠ¡æ•°ï¼›
    - ä» JSON ä¸­è¯»å–çš„å®é™…è¿è¡Œè¿›ç¨‹åˆ—è¡¨ã€‚

## è°ƒåº¦ç¤ºä¾‹

### ç¤ºä¾‹åœºæ™¯

å‡è®¾æœ‰ **2 å¼ å¯ç”¨ GPU**ï¼ˆGPU 4 å’Œ GPU 7ï¼‰ï¼Œä»¥åŠ **3 ä¸ªé˜Ÿåˆ—**å…± 6 ä¸ªä»»åŠ¡ï¼š

| é˜Ÿåˆ— | ä»»åŠ¡ | è¯´æ˜ |
|------|------|------|
| é˜Ÿåˆ— 1 | a â†’ b | æ±½è½¦æ•°æ®é›†ï¼Œç»éªŒæ•° 8 å’Œ 5 |
| é˜Ÿåˆ— 2 | c â†’ d â†’ e | èŠ±æ•°æ®é›†ï¼Œç»éªŒæ•° 15ã€5ã€3 |
| é˜Ÿåˆ— 3 | f | é¸Ÿæ•°æ®é›†ï¼Œç»éªŒæ•° 50 |

### è°ƒåº¦è¿‡ç¨‹ï¼ˆé¡ºåºåˆ†é…ï¼‰

**ç¬¬ 1 è½®è°ƒåº¦**ï¼š
- ç©ºé—²é˜Ÿåˆ—ï¼š{1, 2, 3}ï¼Œå¤´éƒ¨ä»»åŠ¡ï¼š{a, c, f}
- éšæœºæ‰“ä¹±åå‡è®¾é¡ºåºä¸ºï¼š[f, a, c]
- **é€ä¸ªåˆ†é…**ï¼š
  1. åˆ†é… f â†’ GPU 4ï¼Œç­‰å¾…è¿›ç¨‹ç¡®è®¤ï¼ˆæ£€æŸ¥ JSON ä¸­ PID æœ‰æ•ˆï¼‰
  2. ç­‰å¾… 30 ç§’
  3. åˆ†é… a â†’ GPU 7ï¼Œç­‰å¾…è¿›ç¨‹ç¡®è®¤
  4. ç­‰å¾… 30 ç§’
  5. å°è¯•åˆ†é… cï¼Œä½†æ— å¯ç”¨ GPUï¼ˆGPU 4 å’Œ 7 éƒ½æœ‰ç”¨æˆ·è¿›ç¨‹ï¼‰
- é˜Ÿåˆ—çŠ¶æ€ï¼šé˜Ÿåˆ— 1 ğŸ”´ BUSYï¼Œé˜Ÿåˆ— 2 ğŸŸ¢ IDLEï¼Œé˜Ÿåˆ— 3 ğŸ”´ BUSY

**ç¬¬ 2 è½®è°ƒåº¦**ï¼ˆf å®Œæˆåï¼‰ï¼š
- ç©ºé—²é˜Ÿåˆ—ï¼š{2, 3}ï¼ˆé˜Ÿåˆ— 1 çš„ a ä»åœ¨è¿è¡Œï¼‰
- å¤´éƒ¨ä»»åŠ¡ï¼š{c}ï¼ˆé˜Ÿåˆ— 3 å·²æ— ä»»åŠ¡ï¼‰
- åˆ†é… c â†’ GPU 4ï¼Œç­‰å¾…è¿›ç¨‹ç¡®è®¤
- é˜Ÿåˆ—çŠ¶æ€ï¼šé˜Ÿåˆ— 1 ğŸ”´ BUSYï¼Œé˜Ÿåˆ— 2 ğŸ”´ BUSYï¼Œé˜Ÿåˆ— 3 ğŸŸ¢ IDLE

**ç¬¬ 3 è½®è°ƒåº¦**ï¼ˆa å’Œ c éƒ½å®Œæˆåï¼‰ï¼š
- ç©ºé—²é˜Ÿåˆ—ï¼š{1, 2}
- å¤´éƒ¨ä»»åŠ¡ï¼š{b, d}
- éšæœºæ‰“ä¹±åå‡è®¾é¡ºåºä¸ºï¼š[d, b]
- **é€ä¸ªåˆ†é…**ï¼š
  1. åˆ†é… d â†’ GPU 4ï¼Œç­‰å¾…è¿›ç¨‹ç¡®è®¤
  2. ç­‰å¾… 30 ç§’
  3. åˆ†é… b â†’ GPU 7ï¼Œç­‰å¾…è¿›ç¨‹ç¡®è®¤
- é˜Ÿåˆ—çŠ¶æ€ï¼šé˜Ÿåˆ— 1 ğŸ”´ BUSYï¼Œé˜Ÿåˆ— 2 ğŸ”´ BUSYï¼Œé˜Ÿåˆ— 3 ğŸŸ¢ IDLE

**ç¬¬ 4 è½®è°ƒåº¦**ï¼ˆb å®Œæˆåï¼‰ï¼š
- ç©ºé—²é˜Ÿåˆ—ï¼š{1}ï¼ˆé˜Ÿåˆ— 2 çš„ d ä»åœ¨è¿è¡Œï¼‰
- é˜Ÿåˆ— 1 å·²æ— ä»»åŠ¡ï¼Œæ— æ–°ä»»åŠ¡å¯è°ƒåº¦

**ç¬¬ 5 è½®è°ƒåº¦**ï¼ˆd å®Œæˆåï¼‰ï¼š
- ç©ºé—²é˜Ÿåˆ—ï¼š{2}
- å¤´éƒ¨ä»»åŠ¡ï¼š{e}
- åˆ†é… e â†’ GPU 4 æˆ– GPU 7

**æœ€ç»ˆ**ï¼šæ‰€æœ‰ä»»åŠ¡å®Œæˆã€‚

### å…³é”®ç‰¹æ€§

1. **é˜Ÿåˆ—å†…ä¸¥æ ¼ä¸²è¡Œ**ï¼šé˜Ÿåˆ— 1 çš„ b å¿…é¡»ç­‰ a å®Œæˆåæ‰èƒ½æ‰§è¡Œ
2. **é˜Ÿåˆ—é—´å¹¶è¡Œ**ï¼ša å’Œ f å¯ä»¥åŒæ—¶åœ¨ä¸åŒ GPU ä¸Šæ‰§è¡Œ
3. **é¡ºåºåˆ†é…**ï¼šæ¯æ¬¡åªåˆ†é…ä¸€ä¸ªä»»åŠ¡ï¼Œç­‰å¾… 30 ç§’ç¡®è®¤è¿›ç¨‹å¯åŠ¨åå†åˆ†é…ä¸‹ä¸€ä¸ª
4. **è¿›ç¨‹ç¡®è®¤**ï¼šé€šè¿‡æ£€æŸ¥ JSON ä¸­çš„ PID æ˜¯å¦æœ‰æ•ˆæ¥ç¡®è®¤è¿›ç¨‹å·²å¯åŠ¨
5. **GPU ç‹¬å **ï¼šéæé™æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ª GPU åŒæ—¶åªè¿è¡Œä¸€ä¸ªå½“å‰ç”¨æˆ·çš„è¿›ç¨‹
6. **åŠ¨æ€åˆ†é…**ï¼šä»»åŠ¡ä¸é¢„å…ˆç»‘å®š GPUï¼Œè¿è¡Œæ—¶æ ¹æ®èµ„æºæƒ…å†µåŠ¨æ€åˆ†é…

## æ ¸å¿ƒç»„ä»¶

### 1. å”¯ä¸€æ ‡è¯†ç¬¦å‚æ•°

æ‰€æœ‰ä¸»è¦è„šæœ¬éƒ½æ”¯æŒ `--uni_id` å‚æ•°ï¼š
- `run_pipeline.sh`
- `run_build_knowledge_base.sh`
- `run_discovery.sh`
- `run_fast_slow.sh`

ä½¿ç”¨ç¤ºä¾‹ï¼š
```bash
### 2. è¿›ç¨‹çŠ¶æ€ç®¡ç†

#### JSONæ–‡ä»¶ç»“æ„
è¿›ç¨‹çŠ¶æ€ä¿å­˜åœ¨ `./script_process/uni_id.json` æ–‡ä»¶ä¸­ï¼Œæ¯ä¸ª `uni_id` å¯¹åº”ä¸€ä¸ª**è®°å½•å­—å…¸**ï¼š

```json
{
  "exp001": {
    "pid": 12345,
    "state": "running",
    "retry_count": 0,
    "error_type": "runtime_error"
  },
  "exp002": {
    "pid": 12346,
    "state": "normal_exit",
    "retry_count": 3
  }
}
```

#### å­—æ®µè¯´æ˜
- **é”®**: å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆuni_idï¼‰
- **å€¼**: è®°å½•å­—å…¸ï¼ŒåŒ…å«ï¼š
  - `pid`: è¿›ç¨‹ IDï¼ˆæ•´æ•°ï¼‰ï¼›
  - `state`: è¿›ç¨‹çŠ¶æ€ï¼Œ`running` / `normal_exit` / `abnormal_exit`ï¼›
  - `retry_count`: å½“å‰å·²é‡è¯•æ¬¡æ•°ï¼ˆæ•´æ•°ï¼Œé»˜è®¤ 0ï¼‰ï¼›
  - `error_type`: å¯é€‰å­—æ®µï¼Œä»…åœ¨ `abnormal_exit` æ—¶å­˜åœ¨ï¼Œä¾‹å¦‚ `oom` / `runtime_error` / `unknown`ã€‚

å¦‚æœ JSON æ–‡ä»¶ä¸¢å¤±ã€ä¸ºç©ºæˆ–å†…å®¹æŸåï¼ˆæ— æ³•è§£æ / ä¸æ˜¯å­—å…¸ï¼‰ï¼Œ`compete_gpus_retry.py` ä¼šè‡ªåŠ¨å°†å…¶é‡ç½®ä¸º `{}` å¹¶åœ¨æ—¥å¿—ä¸­ç»™å‡ºè­¦å‘Šï¼Œè€Œä¸ä¼šå½±å“ä¸»å¾ªç¯é€»è¾‘ï¼Œä»è€Œä¿è¯ç³»ç»Ÿåœ¨äººå·¥è¯¯åˆ æˆ–ç¼–è¾‘é”™è¯¯åä»èƒ½è‡ªåŠ¨æ¢å¤ã€‚

### 3. è„šæœ¬è¡Œä¸ºæ¨¡å¼

#### æ ‡å‡†æ¨¡å¼ï¼ˆæ—  --uni_idï¼‰
- è„šæœ¬æŒ‰åŸæœ‰é€»è¾‘è¿è¡Œ
- åå°å¯åŠ¨Pythonè¿›ç¨‹
- æ˜¾ç¤ºè¿›ç¨‹PIDå’Œæ—¥å¿—ä¿¡æ¯
- ä¸æ›´æ–°JSONæ–‡ä»¶

#### ç®¡ç†æ¨¡å¼ï¼ˆæœ‰ --uni_idï¼‰
- è„šæœ¬å¯åŠ¨æ—¶åœ¨JSONä¸­è®°å½• uni_id åˆ° PID çš„æ˜ å°„
- Pythonè¿›ç¨‹åœ¨åå°è¿è¡Œ
- è„šæœ¬ç­‰å¾…è¿›ç¨‹ç»“æŸï¼ˆä½¿ç”¨ `wait` å‘½ä»¤ï¼‰
- è¿›ç¨‹ç»“æŸåJSONè®°å½•ä¿æŒä¸å˜ï¼ˆPIDå¯ç”¨äºæ£€æŸ¥è¿›ç¨‹çŠ¶æ€ï¼‰

## å®ç°ç»†èŠ‚

### 1. æ”¯æŒçš„è„šæœ¬ç±»å‹

ç³»ç»Ÿæ”¯æŒä¸¤ç§ç±»å‹çš„è„šæœ¬ï¼š

#### Bash è„šæœ¬ï¼ˆé—´æ¥å¯åŠ¨ Pythonï¼‰
- `run_pipeline.sh`ã€`run_build_knowledge_base.sh`ã€`run_discovery.sh`ã€`run_fast_slow.sh`
- Bash è„šæœ¬è´Ÿè´£åœ¨ JSON ä¸­æ³¨å†Œ Python è¿›ç¨‹çš„ PID
- é€šè¿‡ `wait` å‘½ä»¤ç­‰å¾… Python è¿›ç¨‹ç»“æŸï¼Œå¹¶æ ¹æ®é€€å‡ºç æ›´æ–°çŠ¶æ€
- é€šè¿‡æ£€æŸ¥æ—¥å¿—æ–‡ä»¶åˆ¤æ–­é”™è¯¯ç±»å‹ï¼ˆOOMã€RuntimeError ç­‰ï¼‰

#### Python è„šæœ¬ï¼ˆç›´æ¥è¿è¡Œï¼‰
- `compete_gpus_retry.py` å¯ä»¥ç›´æ¥å¯åŠ¨ Python è„šæœ¬
- ç›´æ¥è·å– Python è¿›ç¨‹çš„ PID å’Œå¼‚å¸¸ä¿¡æ¯
- æ›´ç®€å•çš„é”™è¯¯å¤„ç†æµç¨‹

### 2. JSON æ–‡ä»¶ç®¡ç†

æ¯ä¸ªè„šæœ¬éƒ½åŒ…å«å¥å£®çš„ JSON ç®¡ç†é€»è¾‘ï¼š

```bash
# è¿›ç¨‹ç®¡ç†ç›®å½•å’Œæ–‡ä»¶è·¯å¾„ï¼ˆå§‹ç»ˆå®šä¹‰ï¼‰
PROCESS_DIR="${SCRIPT_DIR}/script_process"
UNI_ID_FILE="${PROCESS_DIR}/uni_id.json"

# æ›´æ–° uni_id çŠ¶æ€çš„å‡½æ•°ï¼ˆå§‹ç»ˆå®šä¹‰ï¼Œä¾›åç»­ä½¿ç”¨ï¼‰
update_uni_id_status() {
    local uni_id=$1
    local state=$2
    local pid=$3
    local error_type=$4
    
    # ç¡®ä¿ç›®å½•å’Œæ–‡ä»¶å­˜åœ¨
    mkdir -p "${PROCESS_DIR}"
    if [ ! -f "${UNI_ID_FILE}" ]; then
        echo "{}" > "${UNI_ID_FILE}"
    fi
    
    # ä½¿ç”¨ Python æ›´æ–° JSONï¼ˆå¤„ç†å„ç§è¾¹ç•Œæƒ…å†µï¼‰
    python3 -c "
import json, os, sys

# å®‰å…¨åŠ è½½ JSON
try:
    if os.path.exists('${UNI_ID_FILE}'):
        with open('${UNI_ID_FILE}', 'r') as f:
            content = f.read().strip()
            data = json.loads(content) if content else {}
            if not isinstance(data, dict):
                data = {}
    else:
        data = {}
except:
    data = {}

# æ›´æ–°è®°å½•
if '${uni_id}' not in data:
    data['${uni_id}'] = {}
record = data['${uni_id}']
record['pid'] = int('${pid}') if '${pid}' else 0
record['state'] = '${state}'
record['retry_count'] = record.get('retry_count', 0)

# è®¾ç½®é”™è¯¯ç±»å‹
if '${error_type}' and '${error_type}' != 'none':
    record['error_type'] = '${error_type}'
elif 'error_type' in record and '${state}' == 'normal_exit':
    del record['error_type']

# å®‰å…¨å†™å…¥
with open('${UNI_ID_FILE}', 'w') as f:
    json.dump(data, f, indent=2)
"
}
```

### 3. é”™è¯¯ç±»å‹æ£€æµ‹

Bash è„šæœ¬é€šè¿‡æ£€æŸ¥æ—¥å¿—æ–‡ä»¶åˆ¤æ–­é”™è¯¯ç±»å‹ï¼š

```bash
if [ ${EXIT_CODE} -ne 0 ]; then
    if grep -i "out of memory\|cuda out of memory\|oom" "${LOG_FILE}" >/dev/null 2>&1; then
        ERROR_TYPE="oom"
    elif grep -i "RuntimeError\|runtime error" "${LOG_FILE}" >/dev/null 2>&1; then
        ERROR_TYPE="runtime_error"
    else
        ERROR_TYPE="unknown"
    fi
    update_uni_id_status "${UNI_ID}" "abnormal_exit" "${PY_PID}" "${ERROR_TYPE}"
else
    update_uni_id_status "${UNI_ID}" "normal_exit" "${PY_PID}" "none"
fi
```

### 3. è¿›ç¨‹å¯åŠ¨å’Œè·Ÿè¸ª

```bash
if [ -n "${UNI_ID}" ]; then
    # ç®¡ç†æ¨¡å¼
    python discovering.py ... &
    PY_PID=$!
    
    # è®°å½• uni_id åˆ° PID çš„æ˜ å°„
    python -c "
import json
import os

uni_id_file = '${SCRIPT_DIR}/script_process/uni_id.json'
os.makedirs(os.path.dirname(uni_id_file), exist_ok=True)

try:
    with open(uni_id_file, 'r') as f:
        data = json.load(f)
except:
    data = {}

data['${UNI_ID}'] = ${PY_PID}

with open(uni_id_file, 'w') as f:
    json.dump(data, f, indent=2)
"
    
    wait ${PY_PID}
else
    # æ ‡å‡†æ¨¡å¼
    python discovering.py ... &
    PID=$!
    # åŸæœ‰é€»è¾‘
fi
```

## å¤–éƒ¨ç›‘æ§æ¥å£

### compete_gpu.py çš„ä½¿ç”¨æ–¹å¼

`compete_gpu.py` è„šæœ¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç›‘æ§è¿›ç¨‹çŠ¶æ€ï¼š

```python
import json
import os

def get_all_processes():
    """è·å–æ‰€æœ‰è®°å½•çš„è¿›ç¨‹"""
    uni_id_file = "./script_process/uni_id.json"
    
    if not os.path.exists(uni_id_file):
        return {}
    
    with open(uni_id_file, 'r') as f:
        data = json.load(f)
    
    return data

def get_running_processes():
    """è·å–æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹"""
    all_processes = get_all_processes()
    running = {}
    
    for uni_id, pid in all_processes.items():
        try:
            # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦å­˜åœ¨
            os.kill(pid, 0)
            running[uni_id] = pid
        except OSError:
            # è¿›ç¨‹ä¸å­˜åœ¨ï¼Œå¯ä»¥é€‰æ‹©æ¸…ç†è®°å½•
            pass
    
    return running

def is_process_running(uni_id):
    """æ£€æŸ¥ç‰¹å®šuni_idçš„è¿›ç¨‹æ˜¯å¦åœ¨è¿è¡Œ"""
    all_processes = get_all_processes()
    
    if uni_id not in all_processes:
        return False
    
    try:
        os.kill(all_processes[uni_id], 0)
        return True
    except OSError:
        return False

def wait_for_completion(uni_id, check_interval=10):
    """ç­‰å¾…ç‰¹å®šuni_idçš„è¿›ç¨‹å®Œæˆ"""
    while is_process_running(uni_id):
        time.sleep(check_interval)
```

## ä½¿ç”¨åœºæ™¯

### 1. é˜Ÿåˆ—ä¸²è¡Œæ‰§è¡Œ

```python
# compete_gpu.py ä¸­çš„ä¸‰å…ƒç»„é…ç½®
command_tasks = [
    # é˜Ÿåˆ—1ï¼šæ±½è½¦æ•°æ®é›†ä»»åŠ¡ï¼ˆä¸²è¡Œæ‰§è¡Œï¼‰
    (["rm -rf experiments/car196/knowledge_base", "bash set_hyperparameters.sh --experience_number 8", "CUDA_VISIBLE_DEVICES={available_gpu} bash run_pipeline.sh car --uni_id {uni_id}"], 1, 25),
    (["rm -rf experiments/car196/knowledge_base", "bash set_hyperparameters.sh --experience_number 5", "CUDA_VISIBLE_DEVICES={available_gpu} bash run_pipeline.sh car --uni_id {uni_id}"], 1, 25),
    
    # é˜Ÿåˆ—2ï¼šèŠ±æ•°æ®é›†ä»»åŠ¡ï¼ˆä¸²è¡Œæ‰§è¡Œï¼‰
    (["rm -rf experiments/flower102/knowledge_base", "bash set_hyperparameters.sh --experience_number 15", "CUDA_VISIBLE_DEVICES={available_gpu} bash run_pipeline.sh flower --uni_id {uni_id}"], 2, 25),
    (["rm -rf experiments/flower102/knowledge_base", "bash set_hyperparameters.sh --experience_number 5", "CUDA_VISIBLE_DEVICES={available_gpu} bash run_pipeline.sh flower --uni_id {uni_id}"], 2, 25),
    
    # é˜Ÿåˆ—3ï¼šé¸Ÿæ•°æ®é›†ä»»åŠ¡ï¼ˆä¸²è¡Œæ‰§è¡Œï¼‰
    (["rm -rf experiments/bird200/knowledge_base", "bash set_hyperparameters.sh --experience_number 50", "CUDA_VISIBLE_DEVICES={available_gpu} bash run_pipeline.sh bird --uni_id {uni_id}"], 3, 25),
]
```

### 2. é˜Ÿåˆ—å¹¶è¡Œæ‰§è¡Œ

- **åŒä¸€é˜Ÿåˆ—å†…**ï¼šä»»åŠ¡æŒ‰é¡ºåºä¸²è¡Œæ‰§è¡Œï¼ˆå‰ä¸€ä¸ªä»»åŠ¡å®Œæˆåæ‰æ‰§è¡Œä¸‹ä¸€ä¸ªï¼‰
- **ä¸åŒé˜Ÿåˆ—é—´**ï¼šä»»åŠ¡å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼ˆåªè¦GPUèµ„æºå……è¶³ï¼‰
- **GPUåˆ†é…**ï¼šåŠ¨æ€åˆ†é…å¯ç”¨GPUï¼Œä¸å›ºå®šé˜Ÿåˆ—ä¸GPUçš„å¯¹åº”å…³ç³»

### 3. æ‰§è¡Œæµç¨‹

```python
# é˜Ÿåˆ—çŠ¶æ€ç›‘æ§
queue_status = get_queue_status()  # è·å–å½“å‰è¿è¡Œä¸­çš„é˜Ÿåˆ—
can_start = can_start_task(task, queue_status)  # æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å¯ä»¥å¼€å§‹

# ä¸²è¡Œæ‰§è¡Œé€»è¾‘
if task.queue_id not in running_queues:
    # åˆ†é…GPUå¹¶æ‰§è¡Œä»»åŠ¡
    available_gpu = find_available_gpu(task)
    if available_gpu:
        execute_task(task, available_gpu)
```

### 4. çŠ¶æ€ç›‘æ§

```python
# é˜Ÿåˆ—çŠ¶æ€æ˜¾ç¤º
Queue 1: ğŸ”´ BUSY, Pending=3, Running=1, Completed=2, Failed=0
Queue 2: ğŸŸ¢ IDLE, Pending=2, Running=0, Completed=0, Failed=0
Queue 3: ğŸŸ¢ IDLE, Pending=1, Running=0, Completed=0, Failed=0

# GPUçŠ¶æ€æ˜¾ç¤º
GPU 1: Available=15.2GB, User Python Processes=1, Running Tasks=1
  Running Task (Queue 1): bash run_pipeline.sh car --uni_id abc123...
```

## æ³¨æ„äº‹é¡¹

1. **æ–‡ä»¶æƒé™**: ç¡®ä¿ `script_process` ç›®å½•æœ‰å†™æƒé™
2. **è¿›ç¨‹æ¸…ç†**: å¦‚æœè„šæœ¬å¼‚å¸¸é€€å‡ºï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨æ¸…ç†JSONä¸­çš„åƒµå°¸è®°å½•
3. **å¹¶å‘å®‰å…¨**: å¤šä¸ªè„šæœ¬åŒæ—¶æ›´æ–°JSONæ–‡ä»¶æ—¶å¯èƒ½å­˜åœ¨ç«äº‰æ¡ä»¶
4. **PIDé‡ç”¨**: ç³»ç»ŸPIDå¯èƒ½é‡ç”¨ï¼Œéœ€è¦ç»“åˆè¿›ç¨‹çŠ¶æ€æ£€æŸ¥
5. **é˜Ÿåˆ—çº¦æŸ**: åŒä¸€é˜Ÿåˆ—çš„ä»»åŠ¡ä¸¥æ ¼ä¸²è¡Œæ‰§è¡Œï¼Œç¡®ä¿èµ„æºä¸å†²çª
6. **GPUåˆ†é…**: GPUåŠ¨æ€åˆ†é…ï¼Œä¸å›ºå®šé˜Ÿåˆ—ä¸GPUçš„å¯¹åº”å…³ç³»
7. **ä»»åŠ¡é¡ºåº**: åŒä¸€é˜Ÿåˆ—å†…ä»»åŠ¡æŒ‰é…ç½®é¡ºåºæ‰§è¡Œï¼Œä¸å¯æ’é˜Ÿ

## é˜Ÿåˆ—ç®¡ç†ç‰¹æ€§

### ä¸²è¡Œæ‰§è¡Œä¿è¯
- åŒä¸€é˜Ÿåˆ—IDçš„ä»»åŠ¡ä¸¥æ ¼æŒ‰é¡ºåºæ‰§è¡Œ
- å‰ä¸€ä¸ªä»»åŠ¡å®Œæˆåï¼Œä¸‹ä¸€ä¸ªä»»åŠ¡æ‰èƒ½å¼€å§‹
- é€šè¿‡PIDç›‘æ§ç¡®ä¿ä»»åŠ¡çœŸæ­£ç»“æŸ

### å¹¶è¡Œæ‰§è¡Œæ”¯æŒ
- ä¸åŒé˜Ÿåˆ—çš„ä»»åŠ¡å¯ä»¥å¹¶è¡Œæ‰§è¡Œ
- åªè¦GPUèµ„æºå……è¶³ï¼Œæ”¯æŒå¤šé˜Ÿåˆ—åŒæ—¶è¿è¡Œ
- åŠ¨æ€GPUåˆ†é…æœ€å¤§åŒ–èµ„æºåˆ©ç”¨ç‡

### çŠ¶æ€ç›‘æ§
- å®æ—¶æ˜¾ç¤ºé˜Ÿåˆ—çŠ¶æ€ï¼ˆBUSY/IDLEï¼‰
- è¯¦ç»†çš„ä»»åŠ¡æ‰§è¡Œç»Ÿè®¡
- GPUä½¿ç”¨æƒ…å†µå®æ—¶ç›‘æ§

## æ•…éšœæ’é™¤

### 1. JSONæ–‡ä»¶æŸå
```bash
rm -f ./script_process/uni_id.json
# è„šæœ¬ä¼šè‡ªåŠ¨é‡æ–°åˆ›å»º
```

### 2. åƒµå°¸è¿›ç¨‹è®°å½•
æ‰‹åŠ¨æ£€æŸ¥å¹¶æ¸…ç†ï¼š
```bash
python -c "
import json
import os

with open('./script_process/uni_id.json', 'r') as f:
    data = json.load(f)

for uni_id, info in list(data.items()):
    if info.get('running', False):
        try:
            os.kill(info['pid'], 0)
        except OSError:
            del data[uni_id]

with open('./script_process/uni_id.json', 'w') as f:
    json.dump(data, f, indent=2)
"
```

## æ‰©å±•æ€§

è¯¥ç³»ç»Ÿè®¾è®¡ä¸ºå¯æ‰©å±•çš„ï¼Œæœªæ¥å¯ä»¥æ·»åŠ ï¼š
- è¿›ç¨‹ä¼˜å…ˆçº§ç®¡ç†
- GPUä½¿ç”¨ç‡ç›‘æ§
- è‡ªåŠ¨ä»»åŠ¡è°ƒåº¦
- è¿›ç¨‹è¶…æ—¶å¤„ç†
- æ›´è¯¦ç»†çš„è¿›ç¨‹çŠ¶æ€ä¿¡æ¯

---

*è¯¥æ–‡æ¡£æè¿°äº†å½“å‰å®ç°çš„è¿›ç¨‹ç®¡ç†æœºåˆ¶ï¼Œä¸º `compete_gpu.py` æä¾›äº†ç›‘æ§å’Œæ§åˆ¶æ¥å£ã€‚*
