# GPU 竞争调度器项目架构

## 项目概述

GPU 竞争调度器是一个用于管理多个脚本对 GPU 资源竞争使用的系统。支持单卡和多卡两种调度模式，实现队内串行、队间并行的任务调度策略。

## 目录结构

```
scripts/compete_gpu_retry/
├── app/                           # 调度器核心应用
│   ├── main_gpu.py                # 单GPU调度器
│   ├── main_gpus.py               # 多GPU调度器
│   └── utils/                     # 工具模块
│       ├── __init__.py
│       ├── gpu_monitor.py         # GPU 状态监控
│       ├── gpu_select.py          # GPU 智能选择策略
│       ├── parse_command_file.py  # 单GPU命令文件解析器
│       ├── gpus_command_file.py   # 多GPU命令文件解析器
│       ├── process_yaml.py        # YAML 配置文件管理
│       ├── retry.py               # 重试机制配置
│       └── update_state.py        # 状态写入模块（调度器端，写入JSON状态文件）
│
├── command/                       # 命令配置文件目录
│   ├── command_gpu.txt            # 单GPU任务配置（配置1）
│   ├── command_gpu_1.txt          # 单GPU任务配置（配置2）
│   ├── command_gpu_2.txt          # 单GPU任务配置（配置3）
│   ├── command_gpus.txt           # 多GPU任务配置（配置1）
│   ├── command_gpus_1.txt         # 多GPU任务配置（配置2）
│   └── ...                        # 更多配置文件
│
├── config/                        # 配置文件目录
│   ├── gpu_manage.yaml            # 调度器配置文件
│   └── control_setting.yaml       # 控制台配置文件
│
├── control/                       # 控制台（Web UI）
│   ├── run.sh                     # 启动脚本
│   ├── shut_down.sh               # 关闭脚本
│   ├── logs/                      # 控制台日志
│   └── src/                       # 源代码
│       ├── main.py                # FastAPI 主程序
│       ├── column/                # 业务模块
│       │   ├── config_rule.py     # YAML 配置处理
│       │   ├── config_command.py  # 命令配置处理（支持多配置）
│       │   ├── display_state.py   # 调度器状态管理（读取状态、日志绑定）
│       │   ├── manage_gpu.py      # GPU 监控
│       │   └── setting.py         # 系统设置
│       ├── utils/                 # 工具模块
│       │   ├── manage_port.py     # 端口管理
│       │   ├── manage_ip.py       # IP 管理
│       │   └── run_app.py         # 调度器运行管理
│       └── dashboard/             # 前端构建产物
│           └── dist/              # 静态文件
│
├── logs/                          # 调度器日志目录
│   ├── compete_gpu.log            # 单GPU调度器日志
│   ├── compete_gpus.log           # 多GPU调度器日志
│   ├── scheduler_*.log            # 通过控制台启动的调度器日志
│   └── state/                    # 调度器状态文件目录
│       └── {pid}.json             # 调度器状态（按进程PID命名）
│
├── help/                          # 帮助文档
│   ├── 项目架构.md                # 本文档
│   ├── GPU管理后端逻辑.md         # 调度器逻辑说明
│   ├── 控制台后端.md              # 控制台后端 API
│   └── 控制台前端.md              # 控制台前端设计
│
└── test_gpu_memory.py             # GPU 内存测试脚本
```

## 核心组件

### 1. 调度器 (app/)

#### 单GPU调度器 (main_gpu.py)
- 每个任务使用单张 GPU
- 支持 `--command-file` 参数指定配置文件
- 实现队内串行、队间并行调度

#### 多GPU调度器 (main_gpus.py)
- 每个任务可使用多张 GPU
- 支持 `--command-file` 参数指定配置文件
- 优先调度 GPU 需求量大的任务

### 2. 命令配置 (command/)

支持多配置文件，命名规则：
- **配置1**: `command_gpu.txt` / `command_gpus.txt`
- **配置2**: `command_gpu_1.txt` / `command_gpus_1.txt`
- **配置3**: `command_gpu_2.txt` / `command_gpus_2.txt`
- **配置N**: `command_gpu_{N-1}.txt` / `command_gpus_{N-1}.txt`

### 3. 控制台 (control/)

基于 FastAPI + React 的 Web 管理界面：

#### 后端 API
| 路径 | 方法 | 说明 |
|------|------|------|
| `/api/commands/{mode}/list` | GET | 列出所有配置 |
| `/api/commands/{mode}/all` | GET | 获取所有配置数据 |
| `/api/commands/{mode}` | GET | 获取指定配置 |
| `/api/commands/{mode}` | PUT | 更新配置 |
| `/api/commands/{mode}/new` | POST | 创建新配置 |
| `/api/commands/{mode}/{index}` | DELETE | 删除配置 |
| `/api/scheduler/{mode}/start` | POST | 启动调度器 |
| `/api/scheduler/{mode}/stop` | POST | 停止调度器 |
| `/api/scheduler/{mode}/state` | GET | 获取调度器状态 |
| `/api/scheduler/running` | GET | 获取所有运行中调度器详细状态 |
| `/api/scheduler/stop/{pid}` | POST | 通过 PID 停止调度器 |
| `/api/log/bind` | POST | 绑定日志文件到进程 |
| `/api/log/bindings` | GET | 获取所有日志绑定 |
| `/api/log/content` | GET | 读取绑定的日志内容 |
| `/api/log/read` | GET | 通过路径读取日志 |

#### 前端页面
- `/ui/gpu` - GPU 实时监控
- `/ui/command` - 命令配置管理（支持多配置）
- `/ui/state` - 调度器状态监控（实时显示队列和任务状态）
- `/ui/rule` - 规则配置
- `/ui/setting` - 系统设置

## 调度策略

### 核心特性
1. **队内串行**：同一队列的任务按顺序执行
2. **队间并行**：不同队列的任务可同时在不同 GPU 上执行
3. **GPU 占用追踪**：调度器内部维护 GPU 占用状态，避免冲突
4. **智能 GPU 选择**：多个可用 GPU 时使用高频采样策略
5. **重试机制**：任务失败后自动重试，支持退避策略

### GPU 分配逻辑
```
实际使用GPU数量 = min(max_gpu, max(min_gpu, available_gpus - gpu_left))
```

## 使用方式

### 启动控制台
```bash
cd scripts/compete_gpu_retry/control
bash run.sh
```

### 直接运行调度器
```bash
cd scripts/compete_gpu_retry

# 单GPU模式
python app/main_gpu.py --command-file command/command_gpu.txt

# 多GPU模式
python app/main_gpus.py --command-file command/command_gpus.txt

# 使用其他配置
python app/main_gpu.py --command-file command/command_gpu_1.txt
```

### 通过 API 启动调度器
```bash
# 启动配置1的单GPU调度器
curl -X POST "http://localhost:29214/api/scheduler/single/start?config_index=0"

# 启动配置2的多GPU调度器
curl -X POST "http://localhost:29214/api/scheduler/multi/start?config_index=1"
```

## 配置文件格式

### 单GPU配置 (command_gpu.txt)
```
# 队列ID
1
# 命令（不需要引号）
python script.py --arg1 value1
# 显存需求(GB)
20

# 下一个任务块
2
bash run.sh
25
```

### 多GPU配置 (command_gpus.txt)
```
# 队列ID
1
# 命令
python script.py --arg1 value1
# GPU数量需求
2
# 显存需求(GB)
20
```

## 更新日志

### v2.2.0 (2025-12-03)
- **日志绑定功能**：命令配置页面支持为每个进程绑定日志文件
- **进程级状态**：状态页面显示每个进程的详细信息（显存、命令、GPU、重试次数等）
- **日志查看**：状态监控页面支持查看已绑定的日志内容
- **日志独立存储**：日志绑定信息保存在 `control/logs/log_bindings.json`，不修改配置文件
- **状态管理模块**：新增 `display_state.py` 模块统一管理调度器状态和日志绑定

### v2.1.0 (2025-12-03)
- **状态栏功能**：实时显示调度器运行状态
- **状态共享机制**：调度器写入 JSON 状态文件，前端读取展示
- **队列状态监控**：显示每个队列的任务进度、当前任务、GPU 分配
- **进程级停止**：支持通过 PID 停止调度器

### v2.0.0 (2025-12-03)
- **多配置支持**：支持无限数量的配置文件
- **调度器运行 API**：通过控制台启动/停止调度器
- **GPU 占用追踪**：修复队间并行时 GPU 分配冲突问题
- **配置层级**：按 配置 → 队列 → 进程 三级展开

### v1.1.0
- 初始版本
- 单GPU/多GPU调度器
- 队内串行、队间并行
- 重试机制
- Web 控制台
