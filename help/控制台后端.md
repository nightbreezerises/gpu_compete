# GPU 管理器后端方案设计

## 一、系统概述

基于 Python + FastAPI 构建的 GPU 管理器后端服务，提供 GPU 监控、配置管理、命令配置等 API 接口。

**服务地址**：`http://{host}:{port}`
**前端路径**：`/ui`（静态文件服务）
**API 路径**：`/api/*`

## 二、目录结构

```
front_end/
├── config.yaml              # 系统配置
├── run.sh                   # 启动脚本
├── shut_down.sh             # 关闭脚本
├── logs/                    # 日志目录
│   ├── pid.json             # 进程信息
│   └── run.log              # 运行日志
└── src/
    ├── main.py              # 主程序入口
    ├── column/              # 业务模块
    │   ├── __init__.py
    │   ├── config_rule.py   # YAML 配置处理
    │   ├── config_command.py # 命令配置处理
    │   ├── manage_gpu.py    # GPU 监控
    │   ├── setting.py       # 系统设置
    │   └── display_state.py # 状态显示
    ├── utils/               # 工具模块
    │   ├── manage_port.py   # 端口管理
    │   ├── manage_ip.py     # IP 管理
    │   └── util.py          # 通用工具
    └── dashboard/           # 前端构建产物
        └── dist/            # 静态文件
```

## 三、配置文件 (control_setting.yaml)

```yaml
# 目标配置文件路径
target-yaml-path: ../config/gpu_manage.yaml

# 日志目录
log-dir: logs

# 服务端口（冲突时自动切换）
port: 29214

# 允许局域网访问
allow-lan: true

# 绑定地址
bind-address: 0.0.0.0

# 日志级别
log-level: info

# 访问密钥（空字符串表示无需密码）
secret: admin
```

## 四、API 接口

### 路由配置

| 路径 | 说明 |
|------|------|
| `/` | 重定向到 `/ui/` |
| `/ui/*` | 前端 SPA 路由（返回 index.html） |
| `/ui/assets/*` | 前端静态资源（CSS、JS） |
| `/ui/images/*` | 前端图片资源 |
| `/api/*` | API 接口 |

### 认证方式

- **自定义密钥认证**（类似 clash-dashboard）
- 无用户名，仅使用密钥
- **密钥来源**：`config/control_setting.yaml` 中的 `secret` 字段
- 空密钥或 `none`/`null`/`false` 表示无需认证

**密钥配置示例**：
```yaml
# config/control_setting.yaml
secret: "omniai315fgvr_gpu_config"  # 访问密钥
```

**认证流程**：
1. 前端调用 `/api/auth/check` 检查是否需要认证
2. 如果 `requires_auth: true`，显示自定义登录界面
3. 用户输入密钥，前端调用 `/api/auth/login` 验证
4. 验证成功后，前端记录认证状态，允许访问所有页面

### 认证 API

| 方法 | 路径 | 说明 | 认证 |
|------|------|------|------|
| GET | `/api/auth/check` | 检查是否需要认证 | 不需要 |
| POST | `/api/auth/login` | 登录验证 | 不需要 |

**GET /api/auth/check 响应**：
```json
{"requires_auth": true}   // 需要密钥
{"requires_auth": false}  // 无需认证
```

**POST /api/auth/login 请求**：
```json
{"password": "your_secret_key"}
```

**POST /api/auth/login 响应**：
```json
{"success": true, "message": "登录成功"}
{"success": false, "message": "密码错误"}
```

### GPU 监控 API

| 方法 | 路径 | 说明 | 认证 |
|------|------|------|------|
| GET | `/api/gpu` | 获取 GPU 监控数据 | 不需要 |
| GET | `/api/gpu/processes` | 获取 GPU 进程列表 | 不需要 |
| GET | `/api/gpu/state` | 获取监控服务状态 | 不需要 |

**GET /api/gpu 响应示例**：
```json
{
  "available": true,
  "timestamp": "2025-12-02T01:00:00",
  "gpu_count": 4,
  "total_processes": 8,
  "memory_percent": 65.5,
  "active_user_count": 3,
  "active_users": ["alice", "bob", "charlie"],
  "host": {
    "hostname": "gpu-server-01",
    "cpu": { "percent": 25.5, "count": 32 },
    "memory": { "used_human": "64GB", "total_human": "128GB" }
  },
  "gpus": [
    {
      "index": 0,
      "name": "NVIDIA A100",
      "temperature": 45,
      "utilization": { "gpu": 80 },
      "memory": {
        "used_human": "20GB",
        "total_human": "40GB",
        "percent": 50
      },
      "power": {
        "draw_human": "150W",
        "limit_human": "300W"
      },
      "processes": [
        { "pid": 12345, "username": "alice", "gpu_memory_human": "10GB" }
      ]
    }
  ]
}
```

### 规则配置 API

| 方法 | 路径 | 说明 | 认证 |
|------|------|------|------|
| GET | `/api/config` | 获取规则配置 | 不需要 |
| PUT | `/api/config` | 更新规则配置 | 不需要 |

**配置数据结构**：
```json
{
  "check_time": 60,
  "maximize_resource_utilization": false,
  "memory_save_mode": false,
  "compete_gpus": [0, 1, 2, 3],
  "use_all_gpus": true,
  "gpu_left": 0,
  "min_gpu": 1,
  "max_gpu": 4,
  "work_dir": "/path/to/work",
  "gpu_command_file": "command/command_gpu.txt",
  "gpus_command_file": "command/command_gpus.txt",
  "retry_config": {
    "max_retry_before_backoff": 3,
    "backoff_duration": 300
  }
}
```

**注意**：配置文件现在位于 `config/gpu_manage.yaml`。

### 命令配置 API

| 方法 | 路径 | 说明 | 认证 |
|------|------|------|------|
| GET | `/api/commands/{mode}/list` | 列出所有配置文件 | 不需要 |
| GET | `/api/commands/{mode}/all` | 获取所有配置数据 | 不需要 |
| GET | `/api/commands/{mode}?config_index=N` | 获取指定配置 | 不需要 |
| PUT | `/api/commands/{mode}?config_index=N` | 更新指定配置 | 不需要 |
| POST | `/api/commands/{mode}/new` | 创建新配置 | 不需要 |
| DELETE | `/api/commands/{mode}/{config_index}` | 删除配置 | 不需要 |
| POST | `/api/commands/{mode}/reset?config_index=N` | 重置配置 | 不需要 |

**路径参数**：
- `mode`: `single`（单卡）或 `multi`（多卡）
- `config_index`: 配置索引（0=配置1, 1=配置2, ...）

**配置文件命名规则**：
- 配置1: `command_gpu.txt` / `command_gpus.txt`
- 配置2: `command_gpu_1.txt` / `command_gpus_1.txt`
- 配置N: `command_gpu_{N-1}.txt` / `command_gpus_{N-1}.txt`

**GET /api/commands/{mode}/list 响应**：
```json
{
  "configs": [
    {"index": 0, "name": "配置 1", "file_name": "command_gpu.txt", "exists": true},
    {"index": 1, "name": "配置 2", "file_name": "command_gpu_1.txt", "exists": true}
  ],
  "mode": "single"
}
```

**配置数据结构**：
```json
{
  "queues": [
    {
      "id": 1,
      "processes": [
        {
          "id": 1,
          "commands": ["command1", "command2"],
          "gpu_count": 1,
          "memory": 20
        }
      ]
    }
  ]
}
```

### 调度器运行 API

| 方法 | 路径 | 说明 | 认证 |
|------|------|------|------|
| POST | `/api/scheduler/{mode}/start?config_index=N` | 启动调度器 | 不需要 |
| POST | `/api/scheduler/{mode}/stop?config_index=N` | 停止调度器 | 不需要 |
| GET | `/api/scheduler/{mode}/state?config_index=N` | 获取调度器状态 | 不需要 |
| GET | `/api/scheduler/state` | 获取所有调度器状态 | 不需要 |
| GET | `/api/scheduler/running` | 获取运行中调度器详细状态 | 不需要 |
| POST | `/api/scheduler/stop/{pid}` | 通过 PID 停止调度器 | 不需要 |

**POST /api/scheduler/{mode}/start 响应**：
```json
{
  "success": true,
  "message": "调度器已启动",
  "pid": 12345,
  "log_file": "/path/to/logs/scheduler_single_0.log",
  "config_file": "/path/to/command/command_gpu.txt"
}
```

**GET /api/scheduler/{mode}/state 响应**：
```json
{
  "running": true,
  "pid": 12345
}
```

**GET /api/scheduler/running 响应**（详细状态）：
```json
{
  "schedulers": [
    {
      "pid": 12345,
      "mode": "single",
      "config_index": 0,
      "config_file": "/path/to/command/command_gpu.txt",
      "state": "running",
      "started_at": "2025-12-03T02:14:39",
      "total_tasks": 5,
      "pending_tasks": 2,
      "running_tasks": 1,
      "completed_tasks": 2,
      "failed_tasks": 0,
      "gpus_used": [0, 1, 2],
      "gpu_assignments": {"1": 1, "2": 2},
      "queues": {
        "1": {
          "id": 1,
          "state": "running",
          "total_tasks": 2,
          "pending_tasks": 1,
          "running_tasks": 1,
          "completed_tasks": 0,
          "current_task": "任务 1/2: python script.py...",
          "current_gpu": 1,
          "last_error": null
        }
      }
    }
  ]
}
```

### 日志绑定 API

| 方法 | 路径 | 说明 | 认证 |
|------|------|------|------|
| POST | `/api/log/bind` | 绑定日志文件 | 不需要 |
| DELETE | `/api/log/bind` | 解除日志绑定 | 不需要 |
| GET | `/api/log/bindings` | 获取所有日志绑定 | 不需要 |
| GET | `/api/log/content` | 读取绑定的日志内容 | 不需要 |
| GET | `/api/log/read` | 通过路径读取日志 | 不需要 |

**POST /api/log/bind 参数**：
- `mode`: single 或 multi
- `config_index`: 配置索引
- `queue_id`: 队列 ID
- `process_index`: 进程索引
- `log_path`: 日志文件绝对路径

**响应示例**：
```json
{
  "success": true,
  "message": "日志绑定成功"
}
```

**GET /api/log/bindings 响应**：
```json
{
  "single_0_1_0": {
    "mode": "single",
    "config_index": 0,
    "queue_id": 1,
    "process_index": 0,
    "log_path": "/path/to/log.txt",
    "bound_at": "2025-12-03T02:44:56"
  }
}
```

### 系统设置 API

| 方法 | 路径 | 说明 | 认证 |
|------|------|------|------|
| GET | `/api/settings` | 获取系统设置 | 不需要 |
| PUT | `/api/settings` | 更新系统设置 | 不需要 |

**GET 响应示例**：
```json
{
  "target-yaml-path": {
    "value": "../config/gpu_manage.yaml",
    "requires_restart": false,
    "warning": null,
    "description": "要操作的 YAML 文件路径"
  },
  "port": {
    "value": 29214,
    "requires_restart": true,
    "warning": "修改端口后，下次启动可能使用新端口",
    "description": "当前任务运行端口"
  }
}
```

**PUT 请求示例**：
```json
{
  "port": 29215,
  "allow-lan": false,
  "log-level": "debug"
}
```

**PUT 响应示例**：
```json
{
  "message": "设置保存成功",
  "requires_restart": ["port"],
  "warnings": ["修改端口后，下次启动可能使用新端口"]
}
```

## 五、核心模块

### 1. GPU 监控 (manage_gpu.py)

基于 nvitop 库实现：

| 函数 | 功能 |
|------|------|
| `get_gpu_summary()` | 获取所有 GPU 概要信息 |
| `get_gpu_list()` | 获取 GPU 设备列表 |
| `get_gpu_info()` | 获取单个 GPU 详细信息 |
| `get_gpu_processes()` | 获取 GPU 进程信息 |
| `get_all_gpu_processes()` | 获取所有 GPU 进程 |
| `get_host_info()` | 获取主机 CPU/内存信息 |

### 2. YAML 配置处理 (config_rule.py)

| 类/函数 | 功能 |
|---------|------|
| `YAMLConfigHandler` | YAML 配置文件处理器 |
| `load_config()` | 读取配置文件 |
| `save_config()` | 保存配置文件（保留注释） |

### 3. 命令配置处理 (config_command.py)

| 类/函数 | 功能 |
|---------|------|
| `CommandConfigHandler` | 命令配置处理器 |
| `load_command_config()` | 读取命令配置 |
| `save_command_config()` | 保存命令配置 |
| `validate_command_config()` | 验证配置数据 |
| `reset_command_config()` | 重置到备份 |

### 4. 系统设置处理 (setting.py)

| 类/函数 | 功能 |
|---------|------|
| `SystemSettingsHandler` | 系统设置处理器 |
| `load_settings()` | 读取系统设置 |
| `save_settings()` | 保存系统设置 |
| `validate_settings()` | 验证设置数据 |
| `get_setting_info()` | 获取设置项信息 |

### 5. 端口管理 (manage_port.py)

| 函数 | 功能 |
|------|------|
| `find_available_port()` | 查找可用端口 |
| `register_process_info()` | 注册进程信息 |
| `unregister_process_info()` | 注销进程信息 |
| `cleanup_pid_file()` | 清理 PID 文件 |
| `validate_port_range()` | 验证端口范围 |
| `log_port_change()` | 记录端口变更 |

## 六、静态文件服务

```python
# main.py
from fastapi.staticfiles import StaticFiles
from fastapi.responses import RedirectResponse

# 挂载前端静态文件到 /ui 路径
app.mount("/ui", StaticFiles(directory=str(STATIC_DIR), html=True), name="static")

# 根路径重定向到 /ui
@app.get("/")
def redirect_to_ui():
    return RedirectResponse(url="/ui/")
```

## 七、认证实现

```python
from fastapi.security import HTTPBasic, HTTPBasicCredentials

security = HTTPBasic()

def verify_credentials(credentials: HTTPBasicCredentials = Depends(security)):
    if credentials.username != "admin" or credentials.password != SECRET:
        raise HTTPException(
            state_code=state.HTTP_401_UNAUTHORIZED,
            detail="Invalid credentials",
            headers={"WWW-Authenticate": "Basic"},
        )
    return credentials
```

## 八、启动流程

```python
if __name__ == "__main__":
    # 1. 清理旧的 PID 文件
    cleanup_pid_file()
    
    # 2. 注册进程信息
    register_process_info(PORT, BIND_ADDRESS)
    
    # 3. 注册退出清理函数
    atexit.register(cleanup_on_exit)
    
    # 4. 处理信号
    signal.signal(signal.SIGTERM, signal_handler)
    signal.signal(signal.SIGINT, signal_handler)
    
    # 5. 启动服务
    uvicorn.run(app, host=BIND_ADDRESS, port=PORT)
```

## 九、依赖

```
fastapi
uvicorn
pyyaml
ruamel.yaml
nvitop
psutil
pydantic
```

## 十、更新日志

### v2.2.0 (2025-12-03)

- **日志绑定 API**：新增日志绑定/解绑/查看 API
- **进程级状态**：调度器状态包含每个进程的详细信息
- **状态管理模块**：新增 `display_state.py` 模块管理调度器状态和日志绑定
- **日志独立存储**：日志绑定信息保存在 `control/logs/log_bindings.json`

### v2.0.0 (2025-12-03)

- **多配置支持**：命令配置支持无限数量的配置文件
- **调度器运行 API**：新增启动/停止调度器的 API
- **配置管理 API**：新增创建/删除配置的 API
- **三级展开**：配置 → 队列 → 进程 层级结构

### v1.2.0 (2025-12-02)

- **认证重构**：移除 HTTP Basic Auth，改用自定义密钥认证
- **新增 API**：`/api/auth/check` 和 `/api/auth/login`
- **SPA 支持**：修复前端路由，所有 `/ui/*` 返回 index.html
- **无用户名**：仅使用密钥认证，类似 clash-dashboard
- **API 无认证**：所有业务 API 移除认证要求，仅登录需要验证
- **图片资源**：新增 `/ui/images/*` 静态资源路由
- **视觉升级**：
  - 登录界面重构：单一卡片设计，去除多余边框，优化视觉体验
  - 配置页面重构：规则页和设置页改为双栏 Grid 布局，采用卡片式设计分组，修复全局样式限制，大幅增加列间距以实现清晰的全屏视觉分离
  - 样式优化：仿照 clash-dashboard 风格，使用现代化组件和颜色系统

### v1.1.0 (2025-12-02)

- **路由变更**：前端静态文件从 `/` 改为 `/ui`
- **根路径重定向**：访问 `/` 自动跳转到 `/ui/`
- **API 路径不变**：所有 API 仍在 `/api/*` 下

### v1.1.0

- 初始版本
- GPU 监控 API
- 规则配置 API
- 命令配置 API
- 系统设置 API
- 端口自动检测
- HTTP Basic Auth 认证
