# GPU 竞争调度器配置编辑系统

## 一、系统概述

Web 可视化配置编辑系统，用于编辑 GPU 竞争调度器的 YAML 配置文件，并提供类似 nvitop 的 GPU 实时监控功能。

**核心功能**：
- 可视化编辑 YAML 配置文件
- **GPU 实时监控**（类似 nvitop）
- 端口冲突自动检测与切换
- 多实例并行运行支持
- 进程状态管理

## 二、目录结构

```
front_end/
├── config.yaml          # 系统配置
├── run.sh               # 启动脚本
├── shut_down.sh         # 关闭脚本
├── logs/                # 日志目录
│   ├── pid.json         # 进程信息
│   └── run.log          # 运行日志
└── src/                 # 源代码
    ├── main.py          # 后端主程序
    ├── column/          # 业务模块
    │   ├── config_rule.py   # YAML处理
    │   └── manage_gpu.py    # GPU监控
    ├── utils/           # 工具模块
    │   └── manage_port.py   # 端口管理
    └── dashboard/       # 前端项目
        └── dist/        # 构建产物
```

## 三、配置文件 (config.yaml)

```yaml
target-yaml-path: ../config.yaml  # 目标配置文件
port: 29214                       # 服务端口
bind-address: 0.0.0.0             # 绑定地址
secret: admin                     # 访问密钥
log-level: info                   # 日志级别
```

## 四、核心模块

### 1. GPU 监控 (manage_gpu.py)

基于 nvitop 库实现，提供类似 nvitop 的 GPU 监控功能：

| 函数 | 功能 |
|------|------|
| `get_gpu_summary()` | 获取所有 GPU 概要信息 |
| `get_gpu_list()` | 获取 GPU 设备列表 |
| `get_gpu_info()` | 获取单个 GPU 详细信息 |
| `get_gpu_processes()` | 获取 GPU 进程信息 |
| `get_host_info()` | 获取主机 CPU/内存信息 |

**监控信息包括**：
- GPU 数量、型号、UUID
- GPU 利用率、显存利用率
- 温度、功耗、时钟频率
- 运行进程（PID、用户、显存占用）
- 主机 CPU、内存使用情况

### 2. 端口管理 (manage_port.py)

| 函数 | 功能 |
|------|------|
| `find_available_port()` | 查找可用端口 |
| `register_process_info()` | 注册进程信息到 pid.json |
| `unregister_process_info()` | 注销进程信息 |
| `get_local_ip()` | 获取本机IP地址 |

### 3. YAML处理 (config_rule.py)

| 类/函数 | 功能 |
|---------|------|
| `YAMLConfigHandler` | YAML配置文件处理器 |
| `load_config()` | 读取配置文件 |
| `save_config()` | 保存配置文件（保留注释和格式） |

### 4. 系统设置 (setting.py)

| 类/函数 | 功能 |
|---------|------|
| `SystemSettingsHandler` | 系统设置处理器 |
| `load_settings()` | 读取系统设置 |
| `save_settings()` | 保存系统设置（保留注释和格式） |
| `validate_settings()` | 验证设置数据 |
| `get_setting_info()` | 获取设置项信息（警告、描述等） |

### 5. 命令配置 (config_command.py)

| 类/函数 | 功能 |
|---------|------|
| `CommandConfigHandler` | 命令配置处理器 |
| `load_command_config()` | 读取命令配置文件 |
| `save_command_config()` | 保存命令配置文件（保留注释和格式） |
| `validate_command_config()` | 验证命令配置数据 |
| `_parse_command_file()` | 解析txt配置文件 |
| `_generate_file_content()` | 生成txt文件内容 |

## 五、API 接口

### GPU API

| 方法 | 路径 | 说明 | 认证 |
|------|------|------|------|
| GET | `/api/gpu` | 获取 GPU 监控数据 | Basic Auth |
| GET | `/api/gpu/status` | 获取监控服务状态 | 无需认证 |

**响应示例**：
```json
{
  "timestamp": "2025-01-01T12:00:00",
  "hostname": "gpu-server-01",
  "cpu_usage": 25.5,
  "memory_usage": 40.2,
  "gpu_count": 4,
  "total_processes": 8,
  "total_memory_used": 24576,
  "total_memory_total": 98304,
  "active_users": ["alice", "bob"],
  "gpus": [...]
}
```

### 命令配置 API

| 方法 | 路径 | 说明 | 认证 |
|------|------|------|------|
| GET | `/api/commands/{mode}` | 获取命令配置 | Basic Auth |
| PUT | `/api/commands/{mode}` | 更新命令配置 | Basic Auth |
| POST | `/api/commands/{mode}/reset` | 重置命令配置 | Basic Auth |

**路径参数**：
- `mode`: 模式，`single` 表示单卡，`multi` 表示多卡

**获取配置响应示例**：
```json
{
  "queues": [
    {
      "id": 1,
      "commands": [
        "rm -rf {work_dir}/experiments/car196/knowledge_base",
        "bash {work_dir}/scripts/set_hyperparameters.sh --experience_number 8",
        "bash {work_dir}/scripts/run_pipeline.sh car --uni_id {uni_id}"
      ],
      "gpu_count": 1,
      "memory": 20
    }
  ],
  "mode": "single"
}
```

**更新配置请求示例**：
```json
{
  "queues": [
    {
      "id": 1,
      "processes": [
        {
          "id": 1,
          "commands": [
            "rm -rf {work_dir}/experiments/car196/knowledge_base",
            "bash {work_dir}/scripts/set_hyperparameters.sh --experience_number 8",
            "bash {work_dir}/scripts/run_pipeline.sh car --uni_id {uni_id}"
          ],
          "gpu_count": 1,
          "memory": 20
        }
      ]
    }
  ]
}
```

### 系统设置 API

| 方法 | 路径 | 说明 | 认证 |
|------|------|------|------|
| GET | `/api/settings` | 获取系统设置 | Basic Auth |
| PUT | `/api/settings` | 更新系统设置 | Basic Auth |

**获取设置响应示例**：
```json
{
  "port": {
    "value": 29214,
    "requires_restart": true,
    "warning": "修改端口后，下次启动可能使用新端口",
    "description": "当前任务运行端口（如果冲突了自动换一个）"
  },
  "allow-lan": {
    "value": true,
    "requires_restart": false,
    "warning": "禁用局域网访问后，外部主机将无法访问此服务",
    "description": "允许来自局域网外部主机的访问"
  }
}
```

**更新设置请求示例**：
```json
{
  "port": 29215,
  "allow-lan": false
}
```

**更新设置响应示例**：
```json
{
  "message": "设置保存成功",
  "requires_restart": ["port"],
  "warnings": [
    "禁用局域网访问后，外部主机将无法访问此服务",
    "修改端口后，下次启动可能使用新端口"
  ]
}
```

## 六、前端页面

### GPU 监控页面

类似 nvitop 的实时监控界面：

- **概览卡片**：GPU 数量、运行进程、显存使用率、活跃用户
- **主机信息**：主机名、CPU 使用率、内存使用情况
- **GPU 卡片**：每个 GPU 的详细信息
  - GPU 型号、温度
  - GPU 利用率进度条
  - 显存使用进度条
  - 功耗信息
  - 运行进程列表（PID、用户、显存）
- **刷新率控制**：0.5秒 / 1秒 / 2秒 / 5秒

### 系统设置页面

管理 `config.yaml` 配置文件：

- **配置项**：
  - `target-yaml-path`：目标 YAML 文件路径
  - `log-dir`：日志存储目录
  - `port`：服务端口（需重启）
  - `allow-lan`：允许局域网访问
  - `bind-address`：绑定地址（需重启）
  - `log-level`：日志级别
  - `external-controller`：外部控制器地址（需重启）
  - `secret`：访问密钥
- **警告提示**：
  - 修改 `allow-lan`：提示禁用后外部无法访问
  - 修改 `port`：提示下次启动可能使用新端口
  - 修改 `external-controller`：提示下次启动可能使用新地址
- **保留注释**：保存时保留 YAML 文件的注释和格式
- **备份机制**：自动备份原配置文件

### 命令管理页面

管理单卡和多卡命令配置文件：

- **模式切换**：
  - 进程单卡运行：管理 `command_gpu.txt` 文件
  - 进程多卡运行：管理 `command_gpus.txt` 文件
- **队列管理**：
  - 创建新队列（自动分配唯一ID）
  - 删除队列
  - 按队列折叠/展开显示
- **命令配置**：
  - 添加/删除多个命令
  - 支持变量 `{work_dir}` 和 `{uni_id}`
  - 命令列表实时编辑
- **资源需求**：
  - 显存需求设置（GB）
  - GPU数量需求（仅多卡模式）
- **数据验证**：
  - 队列ID唯一性检查
  - 命令非空验证
  - 数值范围验证
- **文件格式**：
  - 自动生成符合格式的txt文件
  - 保留原有注释和格式
  - 自动备份原文件

### 其他页面

- **规则**：GPU 竞争调度器配置编辑
- **状态**：服务状态（开发中）

## 七、使用方法

### 启动服务

```bash
# 进入目录
cd front_end

# 启动服务（自动构建前端）
bash run.sh

# 输出示例：
==========================================
📍 访问地址：
   - 实例 1: http://10.82.1.223:29214 (PID: 12345)
==========================================

### 访问服务

- **前端页面**：http://your-host:port
- **API文档**：http://your-host:port/docs
- **认证信息**：用户名 `admin`，密码为 `config.yaml` 中的 `secret` 值

### 使用说明

1. **GPU监控**：实时查看GPU使用情况和进程信息
   - 支持多种刷新率（0.5秒到5秒）
   - 显示GPU利用率、显存、温度、功耗
   - 查看运行进程和用户信息

2. **系统设置**：管理 `config.yaml` 配置文件
   - 修改服务端口、绑定地址、日志级别等
   - 重要修改会显示警告提示
   - 保存时保留注释和格式
   - 自动备份原配置文件

3. **命令管理**：管理单卡和多卡命令配置
   - 切换单卡/多卡运行模式
   - 创建和管理队列配置
   - 编辑命令列表和资源需求
   - 验证配置数据并保存到txt文件
   - 重置配置到备份文件状态

4. **规则编辑**：修改GPU竞争调度器配置
   - 设置调度间隔、资源利用率策略
   - 配置竞争GPU列表和保留数量

5. **状态查看**：查看服务运行状态（开发中）

### 注意事项

- 修改端口、绑定地址、外部控制器等设置需要重启服务才能生效
- 禁用局域网访问后，外部主机将无法访问服务
- 配置文件会自动备份为 `config.yaml.backup`

### 关闭服务

```bash
# 关闭所有
bash shut_down.sh

# 查看状态
bash shut_down.sh --status
```

## 八、技术栈

| 组件 | 技术 |
|------|------|
| 后端 | Python + FastAPI + Uvicorn |
| 前端 | React + Vite |
| GPU监控 | nvitop + pynvml |
| 配置 | YAML (ruamel.yaml) |
| 认证 | HTTP Basic Auth |

## 九、依赖安装

```bash
# 后端依赖
pip install fastapi uvicorn pyyaml ruamel.yaml nvitop psutil

# 前端依赖
cd src/dashboard && npm install
```

## 十、注意事项

1. **nvitop 依赖**：GPU 监控功能需要安装 nvitop 库
2. **NVIDIA 驱动**：需要安装 NVIDIA 驱动和 CUDA
3. **端口冲突**：系统自动检测端口冲突并切换到可用端口
4. **日志文件**：所有实例共用 `logs/run.log` 日志文件
5. **刷新率**：前端支持 0.5秒~5秒的刷新间隔，可根据需要调整
